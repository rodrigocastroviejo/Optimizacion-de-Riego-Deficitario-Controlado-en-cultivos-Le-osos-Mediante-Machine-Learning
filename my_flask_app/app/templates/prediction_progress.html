{% extends "base.html" %}

{% block title %}Progreso de Predicción - AgroData{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-4">
        <div class="col-lg-10">
            <!-- Tarjeta Principal -->
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Proceso de Predicción en Tiempo Real
                            </h4>
                            <p class="mb-0 mt-1 opacity-75">
                                Generando predicciones de variables climáticas y cálculo de riego
                            </p>
                        </div>
                        <div class="text-end">
                            <span id="elapsedTime" class="badge bg-light text-dark">00:00</span>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Barra de Progreso Principal -->
                    <div class="mb-5">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold text-primary">Progreso General</span>
                            <span id="overallPercentage" class="fw-bold">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="overallProgressBar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%; background: linear-gradient(90deg, #4e54c8, #8f94fb);"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="progress-text">0%</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" id="currentStep">Iniciando...</small>
                        </div>
                    </div>

                    <!-- Pasos del Proceso -->
                    <div class="row mb-4">
                        {% set steps = [
                            {'icon': 'fa-box', 'title': 'Cargar Modelos', 'desc': 'Carga de modelos entrenados'},
                            {'icon': 'fa-database', 'title': 'Cargar Datos', 'desc': 'Datos históricos recientes'},
                            {'icon': 'fa-chart-line', 'title': 'Generar Predicciones', 'desc': 'Ejecutar modelos predictivos'},
                            {'icon': 'fa-layer-group', 'title': 'Unificar Datos', 'desc': 'Integrar todas las predicciones'},
                            {'icon': 'fa-tint', 'title': 'Calcular Riego', 'desc': 'Fórmula de necesidades hídricas'},
                            {'icon': 'fa-chart-bar', 'title': 'Generar Gráficos', 'desc': 'Visualización de resultados'}
                        ] %}
                        
                        {% for step in steps %}
                        <div class="col-md-4 col-lg-2 mb-3">
                            <div class="card step-card border-0 text-center h-100" 
                                 id="step{{ loop.index0 }}">
                                <div class="card-body py-3">
                                    <div class="step-icon mb-2">
                                        <i class="fas {{ step.icon }} fa-2x text-muted"></i>
                                    </div>
                                    <h6 class="card-title mb-1">{{ step.title }}</h6>
                                    <p class="card-text text-muted small mb-0">{{ step.desc }}</p>
                                </div>
                                <div class="card-footer border-0 bg-transparent p-0">
                                    <div class="step-progress" style="height: 4px; background: #e9ecef;">
                                        <div class="step-progress-bar" style="width: 0%; height: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Consola de Mensajes -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-terminal me-2"></i>Consola de Progreso
                                <small class="text-muted ms-2" id="messageCount">0 mensajes</small>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="messageConsole" 
                                 style="height: 300px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4;"
                                 class="p-3 font-monospace small">
                                <div class="console-line">
                                    <span class="text-success">$</span> 
                                    <span class="ms-2">Iniciando proceso de predicción...</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Los mensajes se actualizan automáticamente
                                </small>
                                <button id="clearConsole" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-broom me-1"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Contador de Predicciones -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h2 id="modelsLoaded" class="text-primary mb-1">0</h2>
                                    <p class="text-muted mb-0">Modelos Cargados</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h2 id="variablesPredicted" class="text-success mb-1">0</h2>
                                    <p class="text-muted mb-0">Variables Predichas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h2 id="daysPredicted" class="text-warning mb-1">0</h2>
                                    <p class="text-muted mb-0">Días Predichos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h2 id="irrigationCalculated" class="text-info mb-1">0</h2>
                                    <p class="text-muted mb-0">mm Riego Calculado</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje de Finalización -->
                    <div id="completionMessage" class="mt-4 text-center" style="display: none;">
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <h4 class="alert-heading">
                                <i class="fas fa-check-circle me-2"></i>¡Predicción Completada!
                            </h4>
                            <p id="completionText" class="mb-0">
                                Redirigiendo a los resultados...
                            </p>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        <div class="text-center mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Preparando visualización de resultados...</p>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-light py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Tiempo transcurrido: <span id="elapsedTimeDetailed">0 segundos</span>
                            </small>
                        </div>
                        <div>
                            <button id="cancelBtn" class="btn btn-outline-danger btn-sm me-2">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            <button id="refreshBtn" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Error -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error en la Predicción
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">Ha ocurrido un error durante el proceso de predicción.</p>
                <div class="alert alert-warning">
                    <small>
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>Sugerencias:</strong>
                        <ul class="mb-0 mt-1">
                            <li>Verifica que los modelos estén correctamente entrenados</li>
                            <li>Asegúrate de tener datos históricos disponibles</li>
                            <li>Revisa los permisos de los archivos</li>
                        </ul>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="{{ url_for('main.prediccion') }}" class="btn btn-primary">
                    <i class="fas fa-redo me-1"></i>Reintentar
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

    <script>
        window.PREDICTION_PROCESS_URL = "{{ url_for('main.prediccion_proceso') }}";
        window.API_PREDICTION_PROGRESS_URL = "{{ url_for('main.api_progreso_prediccion') }}";
        window.PREDICTION_RESULTS_URL = "{{ url_for('main.prediccion_resultados') }}";
        window.PREDICTION_MAIN_URL = "{{ url_for('main.prediccion') }}";
    </script>
    <script src="{{ url_for('static', filename='js/prediction_progress.js') }}"></script>
{% endblock %}